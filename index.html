<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bagpipe Judging Widget</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --card2:#0f1730;
      --text:#e8ecff;
      --muted:#aeb7e6;
      --line:rgba(255,255,255,.10);
      --accent:#6aa6ff;
      --accent2:#8cffc9;
      --danger:#ff6a6a;
      --warn:#ffd36a;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(106,166,255,.20), transparent 60%),
        radial-gradient(1000px 700px at 90% 30%, rgba(140,255,201,.13), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1400px;margin:0 auto;padding:28px 18px 64px;}
    header{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;margin-bottom:18px;}
    h1{font-size:22px;margin:0;letter-spacing:.2px;}
    .sub{color:var(--muted);margin-top:6px;font-size:14px;line-height:1.35;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border:1px solid var(--line);
      border-radius:999px;background:rgba(255,255,255,.03);
      color:var(--muted);font-size:13px;
    }

    .stack{display:grid;grid-template-columns:1fr;gap:16px;align-items:start;}

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), transparent 120%), var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .row > *{flex:1}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;}
    input[type="text"], input[type="number"]{
      width:100%;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 11px;
      border-radius:12px;
      outline:none;
    }
    input:disabled{opacity:.55}

    .btn{
      appearance:none;border:none;cursor:pointer;
      padding:10px 12px;border-radius:12px;
      background:rgba(106,166,255,.18);
      color:var(--text);
      border:1px solid rgba(106,166,255,.35);
      font-weight:600;
      transition:transform .06s ease, background .12s ease;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(106,166,255,.25)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:rgba(255,255,255,.06);border:1px solid var(--line)}
    .btn.danger{background:rgba(255,106,106,.14);border:1px solid rgba(255,106,106,.35)}
    .btn:disabled{opacity:.45;cursor:not-allowed}

    .hint{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.35}
    .error{color:var(--danger);font-size:12px;margin-top:8px}
    .ok{color:var(--accent2);font-size:12px;margin-top:8px}
    .divider{height:1px;background:var(--line);margin:14px 0}
    .footer-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;margin-top:12px}
    .kbd{font-family:var(--mono);font-size:12px;padding:2px 6px;border:1px solid var(--line);border-radius:8px;background:rgba(255,255,255,.04);color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:var(--mono)}

    /* Collapsible setup */
    .collapse-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .collapse-head h2{margin:0;font-size:16px}
    .card.collapsed .collapsible-body{display:none}
    .collapse-note{color:var(--muted);font-size:12px;line-height:1.35;margin-top:6px}

    /* Categories table */
    table{width:100%;border-collapse:separate;border-spacing:0 8px;}
    th{color:var(--muted);font-size:12px;text-align:left;padding:0 10px;}
    td{
      background:rgba(255,255,255,.035);
      border:1px solid var(--line);
      padding:10px;
      vertical-align:top;
    }
    tr td:first-child{border-radius:12px 0 0 12px}
    tr td:last-child{border-radius:0 12px 12px 0}

    /* Rankings */
    .rank{font-family:var(--mono);opacity:.9;width:62px}
    .score{font-family:var(--mono);text-align:right;width:86px}
    .rank-link{
      display:inline-block;
      color:var(--text);
      text-decoration:none;
      border-bottom:1px dashed rgba(255,255,255,.25);
      cursor:pointer;
    }
    .rank-link:hover{border-bottom-color: rgba(140,255,201,.65);}

    /* ===== Compact competitor rows ===== */
    .comp-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .comp-row{
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 140%), var(--card2);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
      scroll-margin-top: 16px;
    }
    .comp-row.flash{
      outline:2px solid rgba(106,166,255,.55);
      box-shadow: 0 0 0 6px rgba(106,166,255,.12);
    }

    /* Grid that fits name + score + sliders inline */
    .comp-main{
      display:grid;
      grid-template-columns: 260px 92px 1fr; /* name | total | sliders */
      gap:12px;
      align-items:center;
      width:100%;
    }
    @media (max-width: 980px){
      .comp-main{grid-template-columns: 1fr; align-items:stretch}
    }

    .comp-meta{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .comp-name{
      font-weight:700;
      font-size:14px;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .comp-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .icon-btn{
      padding:8px 10px;
      border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      cursor:pointer;
      font-weight:650;
      font-size:12px;
    }
    .icon-btn:hover{background:rgba(255,255,255,.09)}
    .icon-btn.danger{background:rgba(255,106,106,.14);border-color:rgba(255,106,106,.35)}

    .comp-total{
      display:flex;
      flex-direction:column;
      gap:2px;
      align-items:flex-end;
    }
    @media (max-width: 980px){
      .comp-total{align-items:flex-start}
    }
    .comp-total .label{color:var(--muted);font-size:12px}
    .comp-total .val{font-family:var(--mono);font-weight:750;font-size:16px}

    /* Sliders bar: one row, lots visible */
    .sliders-bar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;          /* wraps if too many categories */
      width:100%;
    }

    /* ===== Heatmap-style slider chips ===== */
    .slider-chip{
      --heat: 0; /* set by JS */
      --hue: calc(var(--heat) * 120); /* 0 red -> 120 green */

      border:1px solid hsla(var(--hue), 90%, 60%, 0.22);
      border-radius:12px;
      padding:8px 10px;
      display:flex;
      align-items:center;
      gap:10px;
      flex: 1 1 220px;
      min-width: 220px;
      max-width: 420px;

      background:
        linear-gradient(180deg, rgba(255,255,255,.04), transparent 140%),
        hsla(var(--hue), 90%, 55%, 0.14);
    }
    @media (max-width: 520px){
      .slider-chip{min-width: 100%;}
    }
    .chip-left{min-width: 120px}
    .chip-cat{font-weight:700;font-size:12px;line-height:1.1}
    .chip-w{color:var(--muted);font-size:11px;line-height:1.1;margin-top:2px}
    .chip-right{
      display:flex;
      gap:10px;
      align-items:center;
      width:100%;
    }
    .chip-val{
      font-family:var(--mono);
      min-width:3.5ch;
      text-align:right;
      color: hsla(var(--hue), 90%, 80%, 0.95);
    }
    input[type="range"]{width:100%}

    .comp-details{
      display:none;
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
    }
    .comp-row.expanded .comp-details{display:block}
    .details-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px 14px;
    }
    @media (max-width: 780px){
      .details-grid{grid-template-columns:1fr}
    }
    .detail-item{display:flex;justify-content:space-between;gap:12px}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;border-radius:12px;
      color:var(--text);font-size:13px;
      backdrop-filter: blur(8px);
      display:none;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Bagpipe Judging Widget</h1>
        <div class="sub">
          Setup categories + weights (total 100%), start the competition, add competitors, then adjust sliders inline (0–10 in 0.5 steps).
          Auto-saves to this browser.
        </div>
      </div>
      <div class="pill">
        <span id="statusDot" style="display:inline-block;width:8px;height:8px;border-radius:999px;background:var(--warn)"></span>
        <span id="statusText">Setup mode</span>
      </div>
    </header>

    <div class="stack">
      <!-- Setup (full width, collapsible) -->
      <section class="card" id="setupCard">
        <div class="collapse-head">
          <h2>1) Setup categories</h2>
          <button class="btn secondary" id="toggleSetupBtn" type="button" style="display:none">Show setup</button>
        </div>

        <div class="collapsible-body" id="setupBody">
          <div class="row" style="margin-top:8px">
            <div>
              <label>Category name</label>
              <input id="catName" type="text" placeholder="e.g., Sound" autocomplete="off" />
            </div>
            <div style="max-width:180px;flex:0 0 180px">
              <label>Weight %</label>
              <input id="catWeight" type="number" min="0" max="100" step="1" placeholder="e.g., 30" />
            </div>
            <div style="max-width:160px;flex:0 0 160px;align-self:end">
              <button class="btn" id="addCategoryBtn" type="button">Add category</button>
            </div>
          </div>

          <div class="hint">Weights must total <span class="kbd">100</span>. Add any categories you want.</div>
          <div id="weightMessage" class="hint"></div>

          <div class="divider"></div>

          <h2 style="margin-top:0">Categories</h2>
          <div id="categoriesEmpty" class="muted">No categories yet.</div>
          <table id="categoriesTable" style="display:none">
            <thead>
              <tr>
                <th style="width:60%">Category</th>
                <th style="width:20%">Weight</th>
                <th style="width:20%"></th>
              </tr>
            </thead>
            <tbody id="categoriesTbody"></tbody>
          </table>

          <div class="footer-actions">
            <button class="btn secondary" id="resetBtn" type="button">Reset</button>
            <button class="btn secondary" id="clearSavedBtn" type="button">Clear saved</button>
            <button class="btn" id="startBtn" type="button" disabled>Start competition</button>
          </div>

          <div id="startError" class="error" style="display:none"></div>
        </div>

        <div class="collapse-note" id="setupCollapsedNote" style="display:none">
          Setup is collapsed to maximize judging space. Click “Show setup” if you need to review it.
        </div>
      </section>

      <!-- Competition (full width) -->
      <section class="card">
        <h2>2–4) Run the competition</h2>

        <div class="row" style="margin-top:8px">
          <div>
            <label>Competitor name</label>
            <input id="compName" type="text" placeholder="e.g., Jane MacLeod" autocomplete="off" disabled />
          </div>
          <div style="max-width:170px;flex:0 0 170px;align-self:end">
            <button class="btn" id="addCompetitorBtn" type="button" disabled>Add competitor</button>
          </div>
        </div>

        <div class="hint">
          <span class="kbd">Tip:</span> Click a name in Rankings to jump to their row. Slider chips tint red→yellow→green as scores rise.
        </div>

        <div class="divider"></div>

        <div class="row" style="align-items:baseline;gap:10px">
          <h2 style="margin:0;flex:1">Rankings</h2>
          <div class="small" id="competitorCount">0 competitors</div>
        </div>

        <div id="rankingsEmpty" class="muted" style="margin-top:10px">
          Start the competition, then add competitors.
        </div>

        <table id="rankingsTable" style="display:none;margin-top:6px">
          <thead>
            <tr>
              <th class="rank">Rank</th>
              <th>Name</th>
              <th class="score">Score</th>
            </tr>
          </thead>
          <tbody id="rankingsTbody"></tbody>
        </table>

        <div class="footer-actions">
          <button class="btn secondary" id="copyBtn" type="button" disabled>Copy text readout</button>
        </div>

        <div class="divider"></div>

        <h2 style="margin-top:0">Judging rows</h2>
        <div id="competitorList" class="comp-list"></div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let categories = [];   // {id, name, weight}
  let competitors = [];  // {id, name, scores:{catId:number}, expanded:boolean}
  let started = false;

  const el = (id) => document.getElementById(id);

  // Setup elements
  const setupCard = el("setupCard");
  const setupBody = el("setupBody");
  const toggleSetupBtn = el("toggleSetupBtn");
  const setupCollapsedNote = el("setupCollapsedNote");

  const catName = el("catName");
  const catWeight = el("catWeight");
  const addCategoryBtn = el("addCategoryBtn");
  const categoriesTable = el("categoriesTable");
  const categoriesTbody = el("categoriesTbody");
  const categoriesEmpty = el("categoriesEmpty");
  const weightMessage = el("weightMessage");
  const startBtn = el("startBtn");
  const resetBtn = el("resetBtn");
  const clearSavedBtn = el("clearSavedBtn");
  const startError = el("startError");

  // Competition elements
  const compName = el("compName");
  const addCompetitorBtn = el("addCompetitorBtn");

  const rankingsEmpty = el("rankingsEmpty");
  const rankingsTable = el("rankingsTable");
  const rankingsTbody = el("rankingsTbody");
  const competitorCount = el("competitorCount");
  const copyBtn = el("copyBtn");

  const competitorList = el("competitorList");

  const statusDot = el("statusDot");
  const statusText = el("statusText");
  const toast = el("toast");

  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  // ===== Persistence (localStorage) =====
  const STORAGE_KEY = "bagpipe_judging_widget_v1";

  function saveState(){
    const payload = {
      version: 1,
      started,
      categories,
      competitors,
      setupCollapsed: setupCard.classList.contains("collapsed"),
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  }

  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    try{
      const data = JSON.parse(raw);
      if (!data || data.version !== 1) return false;

      started = !!data.started;
      categories = Array.isArray(data.categories) ? data.categories : [];
      competitors = Array.isArray(data.competitors) ? data.competitors : [];

      competitors.forEach(c => {
        c.scores = c.scores && typeof c.scores === "object" ? c.scores : {};
        c.expanded = !!c.expanded;
      });

      // Ensure every competitor has every category key
      competitors.forEach(c => {
        categories.forEach(cat => {
          if (typeof c.scores[cat.id] !== "number") c.scores[cat.id] = 0;
        });
      });

      renderCategories();
      setStartedUI(started);
      if (typeof data.setupCollapsed === "boolean") setSetupCollapsed(data.setupCollapsed);
      renderCompetitorRows();
      recalculateAndRenderRankings();
      return true;
    } catch {
      return false;
    }
  }

  function clearSavedState(){
    localStorage.removeItem(STORAGE_KEY);
  }

  // ===== Helpers =====
  function weightsSum(){
    return categories.reduce((acc,c)=>acc+(Number(c.weight)||0),0);
  }

  function showToast(msg){
    toast.textContent = msg;
    toast.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.style.display="none", 1200);
  }

  function setSetupCollapsed(collapsed){
    if (collapsed){
      setupCard.classList.add("collapsed");
      setupBody.style.display = "none";
      setupCollapsedNote.style.display = "block";
      toggleSetupBtn.style.display = "inline-block";
      toggleSetupBtn.textContent = "Show setup";
    } else {
      setupCard.classList.remove("collapsed");
      setupBody.style.display = "block";
      setupCollapsedNote.style.display = "none";
      toggleSetupBtn.style.display = started ? "inline-block" : "none";
      toggleSetupBtn.textContent = "Hide setup";
    }
    saveState();
  }

  function setWeightMessage(){
    const sum = weightsSum();
    const remaining = 100 - sum;

    if (categories.length === 0) {
      weightMessage.className = "hint";
      weightMessage.textContent = "Add at least one category.";
      startBtn.disabled = true;
      return;
    }

    if (sum === 100) {
      weightMessage.className = "ok";
      weightMessage.textContent = "Weights total 100%. Ready to start.";
      startBtn.disabled = started;
    } else if (sum < 100) {
      weightMessage.className = "hint";
      weightMessage.textContent = `Weights total ${sum}%. Add ${remaining}% more.`;
      startBtn.disabled = true;
    } else {
      weightMessage.className = "error";
      weightMessage.textContent = `Weights total ${sum}%. Remove ${Math.abs(remaining)}%.`;
      startBtn.disabled = true;
    }
  }

  function setStartedUI(isStarted){
    started = isStarted;

    if (started) {
      statusDot.style.background = "var(--accent2)";
      statusText.textContent = "Competition running";
      // collapse setup to maximize space
      setupCard.classList.add("collapsed");
      setupBody.style.display = "none";
      setupCollapsedNote.style.display = "block";
      toggleSetupBtn.style.display = "inline-block";
      toggleSetupBtn.textContent = "Show setup";
    } else {
      statusDot.style.background = "var(--warn)";
      statusText.textContent = "Setup mode";
      setupCard.classList.remove("collapsed");
      setupBody.style.display = "block";
      setupCollapsedNote.style.display = "none";
      toggleSetupBtn.style.display = "none";
    }

    catName.disabled = started;
    catWeight.disabled = started;
    addCategoryBtn.disabled = started;
    startBtn.disabled = started || (weightsSum() !== 100) || (categories.length === 0);

    compName.disabled = !started;
    addCompetitorBtn.disabled = !started;

    copyBtn.disabled = !(started && competitors.length > 0);
    saveState();
  }

  function renderCategories(){
    categoriesTbody.innerHTML = "";
    if (categories.length === 0){
      categoriesTable.style.display = "none";
      categoriesEmpty.style.display = "block";
    } else {
      categoriesTable.style.display = "";
      categoriesEmpty.style.display = "none";

      categories.forEach(cat=>{
        const tr = document.createElement("tr");
        const tdName = document.createElement("td");
        const tdWeight = document.createElement("td");
        const tdAction = document.createElement("td");

        tdName.textContent = cat.name;
        tdWeight.innerHTML = `<span class="kbd">${cat.weight}%</span>`;

        const rm = document.createElement("button");
        rm.type = "button";
        rm.className = "btn danger";
        rm.textContent = "Remove";
        rm.disabled = started;
        rm.addEventListener("click", ()=>{
          categories = categories.filter(c=>c.id!==cat.id);
          competitors.forEach(p=>{ delete p.scores[cat.id]; });
          renderCategories();
          renderCompetitorRows();
          recalculateAndRenderRankings();
          saveState();
        });

        tdAction.appendChild(rm);
        tr.appendChild(tdName);
        tr.appendChild(tdWeight);
        tr.appendChild(tdAction);
        categoriesTbody.appendChild(tr);
      });
    }

    setWeightMessage();
  }

  // Weighted score out of 100
  function calculateScore(comp){
    let total = 0;
    for (const cat of categories){
      const raw = Number(comp.scores[cat.id] ?? 0); // 0..10
      total += (raw/10) * Number(cat.weight);
    }
    return total;
  }

  // Heat helper: set 0..1 heat value based on 0..10 score
  function setChipHeat(chipEl, value0to10){
    const heat = Math.max(0, Math.min(1, (Number(value0to10) || 0) / 10));
    chipEl.style.setProperty("--heat", heat.toFixed(3));
  }

  function scrollToCompetitor(compId){
    const row = document.getElementById(`comp-${compId}`);
    if (!row) return;
    row.scrollIntoView({behavior:"smooth", block:"start"});
    row.classList.add("flash");
    clearTimeout(scrollToCompetitor._t);
    scrollToCompetitor._t = setTimeout(()=>row.classList.remove("flash"), 900);
  }

  function recalculateAndRenderRankings(){
    competitorCount.textContent = `${competitors.length} competitor${competitors.length===1?"":"s"}`;

    if (!started || competitors.length === 0){
      rankingsTable.style.display = "none";
      rankingsEmpty.style.display = "block";
      rankingsTbody.innerHTML = "";
      copyBtn.disabled = true;
      return;
    }

    const scored = competitors.map(c=>({id:c.id, name:c.name, score:calculateScore(c)}));
    scored.sort((a,b)=>(b.score-a.score) || a.name.localeCompare(b.name));

    rankingsTbody.innerHTML = "";
    scored.forEach((s, idx)=>{
      const tr = document.createElement("tr");

      const tdRank = document.createElement("td");
      tdRank.className = "rank";
      tdRank.textContent = `#${idx+1}`;

      const tdName = document.createElement("td");
      const a = document.createElement("a");
      a.className = "rank-link";
      a.href = `#comp-${s.id}`;
      a.textContent = s.name;
      a.addEventListener("click", (e)=>{
        e.preventDefault();
        scrollToCompetitor(s.id);
      });
      tdName.appendChild(a);

      const tdScore = document.createElement("td");
      tdScore.className = "score";
      tdScore.textContent = s.score.toFixed(1);

      tr.appendChild(tdRank);
      tr.appendChild(tdName);
      tr.appendChild(tdScore);
      rankingsTbody.appendChild(tr);
    });

    rankingsEmpty.style.display = "none";
    rankingsTable.style.display = "";
    copyBtn.disabled = false;
  }

  function renderCompetitorRows(){
    competitorList.innerHTML = "";
    if (!started || competitors.length === 0) return;

    competitors.forEach((comp)=>{
      const row = document.createElement("div");
      row.className = "comp-row";
      row.id = `comp-${comp.id}`;
      if (comp.expanded) row.classList.add("expanded");

      const main = document.createElement("div");
      main.className = "comp-main";

      // Name + actions
      const meta = document.createElement("div");
      meta.className = "comp-meta";

      const name = document.createElement("div");
      name.className = "comp-name";
      name.textContent = comp.name;

      const actions = document.createElement("div");
      actions.className = "comp-actions";

      const toggle = document.createElement("button");
      toggle.type = "button";
      toggle.className = "icon-btn";
      toggle.textContent = comp.expanded ? "Hide details" : "Details";
      toggle.addEventListener("click", ()=>{
        comp.expanded = !comp.expanded;
        renderCompetitorRows();
        recalculateAndRenderRankings();
        saveState();
      });

      const del = document.createElement("button");
      del.type = "button";
      del.className = "icon-btn danger";
      del.textContent = "Remove";
      del.addEventListener("click", ()=>{
        competitors = competitors.filter(c=>c.id!==comp.id);
        renderCompetitorRows();
        recalculateAndRenderRankings();
        copyBtn.disabled = !(started && competitors.length > 0);
        saveState();
      });

      actions.appendChild(toggle);
      actions.appendChild(del);

      meta.appendChild(name);
      meta.appendChild(actions);

      // Total score
      const total = document.createElement("div");
      total.className = "comp-total";
      const totalLabel = document.createElement("div");
      totalLabel.className = "label";
      totalLabel.textContent = "Total";
      const totalVal = document.createElement("div");
      totalVal.className = "val";
      totalVal.textContent = calculateScore(comp).toFixed(1);
      total.appendChild(totalLabel);
      total.appendChild(totalVal);

      // Sliders inline
      const sliders = document.createElement("div");
      sliders.className = "sliders-bar";

      for (const cat of categories){
        const chip = document.createElement("div");
        chip.className = "slider-chip";

        const left = document.createElement("div");
        left.className = "chip-left";
        const catNameDiv = document.createElement("div");
        catNameDiv.className = "chip-cat";
        catNameDiv.textContent = cat.name;
        const wDiv = document.createElement("div");
        wDiv.className = "chip-w";
        wDiv.textContent = `${cat.weight}%`;
        left.appendChild(catNameDiv);
        left.appendChild(wDiv);

        const right = document.createElement("div");
        right.className = "chip-right";

        const slider = document.createElement("input");
        slider.type = "range";
        slider.min = "0";
        slider.max = "10";
        slider.step = "0.5";

        const current = Number(comp.scores[cat.id] ?? 0);
        slider.value = String(Math.max(0, Math.min(10, current)));

        const val = document.createElement("div");
        val.className = "chip-val";
        val.textContent = Number(slider.value).toFixed(1);

        // Initial heat tint
        setChipHeat(chip, slider.value);

        slider.addEventListener("input", ()=>{
          const n = Number(slider.value);
          comp.scores[cat.id] = n;
          val.textContent = n.toFixed(1);

          // Update heat tint live
          setChipHeat(chip, slider.value);

          // Update total instantly without re-rendering whole list
          totalVal.textContent = calculateScore(comp).toFixed(1);

          // Update rankings and (if expanded) details
          recalculateAndRenderRankings();
          if (comp.expanded) {
            const details = row.querySelector(".comp-details");
            if (details) details.innerHTML = buildDetailsHTML(comp);
          }
          saveState();
        });

        right.appendChild(slider);
        right.appendChild(val);

        chip.appendChild(left);
        chip.appendChild(right);
        sliders.appendChild(chip);
      }

      main.appendChild(meta);
      main.appendChild(total);
      main.appendChild(sliders);

      row.appendChild(main);

      // Optional details
      const details = document.createElement("div");
      details.className = "comp-details";
      details.innerHTML = buildDetailsHTML(comp);
      row.appendChild(details);

      competitorList.appendChild(row);
    });
  }

  function buildDetailsHTML(comp){
    const parts = [];
    parts.push(`<div class="details-grid">`);
    for (const cat of categories){
      const raw = Number(comp.scores[cat.id] ?? 0);
      parts.push(`
        <div class="detail-item">
          <span>${escapeHtml(cat.name)} <span class="mono">(${cat.weight}%)</span></span>
          <span class="mono">${raw.toFixed(1)} / 10</span>
        </div>
      `);
    }
    parts.push(`</div>`);
    return parts.join("");
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  function buildTextReadout(){
    const lines = [];
    lines.push("Bagpipe Competition – Results");
    lines.push(`Date: ${new Date().toLocaleDateString()}`);
    lines.push("");
    lines.push("Categories (weights):");
    for (const cat of categories) lines.push(`- ${cat.name}: ${cat.weight}%`);
    lines.push("");
    lines.push("Rankings:");

    const scored = competitors
      .map(c => ({ c, score: calculateScore(c) }))
      .sort((a,b) => (b.score - a.score) || a.c.name.localeCompare(b.c.name));

    scored.forEach((s, idx) => {
      lines.push(`${idx + 1}. ${s.c.name} — ${s.score.toFixed(1)} / 100`);
      for (const cat of categories) {
        const raw = Number(s.c.scores[cat.id] ?? 0);
        lines.push(`   • ${cat.name}: ${raw.toFixed(1)} / 10`);
      }
    });

    return lines.join("\n");
  }

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      showToast("Copied!");
    }catch{
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      try { document.execCommand("copy"); showToast("Copied!"); }
      catch { showToast("Copy failed"); }
      document.body.removeChild(ta);
    }
  }

  // ===== Events =====
  addCategoryBtn.addEventListener("click", () => {
    startError.style.display = "none";

    const name = (catName.value || "").trim();
    const w = Number(catWeight.value);

    if (!name) { startError.textContent="Please enter a category name."; startError.style.display="block"; return; }
    if (!Number.isFinite(w) || w <= 0) { startError.textContent="Please enter a weight greater than 0."; startError.style.display="block"; return; }
    if (w > 100) { startError.textContent="Weight can't be more than 100."; startError.style.display="block"; return; }

    const newCat = { id: uid(), name, weight: Math.round(w) };
    categories.push(newCat);
    catName.value = "";
    catWeight.value = "";
    catName.focus();

    // Add the new category key to existing competitors (default 0)
    competitors.forEach(c => { c.scores[newCat.id] = 0; });

    renderCategories();
    renderCompetitorRows();
    recalculateAndRenderRankings();
    saveState();
  });

  startBtn.addEventListener("click", () => {
    startError.style.display = "none";
    const sum = weightsSum();
    if (categories.length === 0) { startError.textContent="Add at least one category before starting."; startError.style.display="block"; return; }
    if (sum !== 100) { startError.textContent=`Weights must total 100%. Current total is ${sum}%.`; startError.style.display="block"; return; }

    setStartedUI(true);
    rankingsEmpty.textContent = "Add competitors to begin scoring.";
    compName.focus();
    saveState();
  });

  toggleSetupBtn.addEventListener("click", () => {
    const isCollapsed = setupCard.classList.contains("collapsed");
    setSetupCollapsed(!isCollapsed ? false : true);
  });

  resetBtn.addEventListener("click", () => {
    categories = [];
    competitors = [];
    renderCategories();
    setStartedUI(false);
    competitorList.innerHTML = "";
    recalculateAndRenderRankings();
    rankingsEmpty.textContent = "Start the competition, then add competitors.";
    startError.style.display = "none";
    catName.focus();
    saveState();
  });

  clearSavedBtn.addEventListener("click", () => {
    clearSavedState();
    showToast("Saved contest cleared");
  });

  addCompetitorBtn.addEventListener("click", () => {
    const name = (compName.value || "").trim();
    if (!name) { showToast("Enter a name"); compName.focus(); return; }
    const exists = competitors.some(c => c.name.toLowerCase() === name.toLowerCase());
    if (exists) { showToast("Name already exists"); compName.select(); return; }

    const c = { id: uid(), name, scores: {}, expanded: false };
    for (const cat of categories) c.scores[cat.id] = 0;

    competitors.push(c);
    compName.value = "";
    compName.focus();

    renderCompetitorRows();
    recalculateAndRenderRankings();
    copyBtn.disabled = !(started && competitors.length > 0);
    saveState();
  });

  compName.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !addCompetitorBtn.disabled) addCompetitorBtn.click();
  });
  catName.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !addCategoryBtn.disabled) {
      if ((catWeight.value || "").trim() === "") catWeight.focus();
      else addCategoryBtn.click();
    }
  });
  catWeight.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !addCategoryBtn.disabled) addCategoryBtn.click();
  });

  copyBtn.addEventListener("click", () => {
    copyToClipboard(buildTextReadout());
  });

  // ===== Init =====
  const restored = loadState();
  if (!restored) {
    renderCategories();
    setStartedUI(false);
    recalculateAndRenderRankings();
    saveState();
  }
});
</script>
</body>
</html>
